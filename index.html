<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CondUnity ‚Ä¢ Mans√£o Jorge Amado</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json" />
<link rel="icon" href="favicon.ico" />
<meta name="theme-color" content="#2563eb" />
<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="apple-touch-icon" href="./icon-192.png" />

<!-- Twemoji para padronizar emojis em todos os dispositivos -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/twemoji.min.js" defer></script>

<style>
/* ====== Design System (claro elegante) ====== */
:root{
  --bg:#f5f7fb;
  --bg-grad: radial-gradient(900px 500px at -10% -10%, #dfe8ff 0%, transparent 50%),
             radial-gradient(900px 600px at 110% -10%, #e3f7ff 0%, transparent 55%);
  --card:#ffffff;
  --muted:#6b7280;
  --text:#0f172a;
  --border:#e5e7eb;
  --primary:#2563eb;
  --primary-2:#1e40af;
  --accent:#06b6d4;
  --ok:#10b981;
  --warn:#f59e0b;
  --radius:16px;
  --shadow:0 10px 30px rgba(15,23,42,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  color:var(--text);
  background: var(--bg);
  background-image: var(--bg-grad);
}

/* ====== Topbar ====== */
.topbar{
  position:sticky; top:0; z-index:50;
  display:flex; align-items:center; gap:12px;
  padding:12px 16px;
  background:linear-gradient(180deg,#1f4fd7 0%, #2563eb 100%);
  color:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
}
.brand{display:flex; align-items:center; gap:12px}
.brand svg{width:36px;height:36px;display:block;border-radius:12px;background:#fff0}
.brand .title{font-weight:800;letter-spacing:.2px}
.topbar .who{margin-left:auto}

/* ====== Layout ====== */
.wrap{max-width:1200px;margin:22px auto;padding:0 16px}
.badge{display:inline-flex;align-items:center;gap:8px;
  border:1px solid var(--border); color:var(--muted);
  padding:6px 10px;border-radius:999px; font-size:12px;background:#fff;}
.grid{display:grid;grid-template-columns:2fr 1.1fr; gap:16px}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }

/* ====== Cards ====== */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.section{padding:16px}
.section h3{margin:0 0 12px 0}
.sub{font-size:12px;color:var(--muted)}

/* ====== Tabs ====== */
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
.tabs button{
  padding:10px 14px;border:1px solid var(--border);border-radius:999px;
  background:#fff; color:var(--text); font-weight:600; cursor:pointer;
}
.tabs button.active{background:linear-gradient(180deg,var(--primary),var(--primary-2)); border-color:transparent; color:#fff}

/* ====== Inputs/Buttons ====== */
.btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text);cursor:pointer;font-weight:600}
.btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary-2)); border-color:transparent; color:#fff}
.btn.ghost{background:#f8fafc}
input,select,textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px}
input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.2);}

/* ====== Chat ====== */
.chat-wrap{display:flex;flex-direction:column;height:520px}
.chat-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
.chat-box{
  flex:1; overflow:auto; padding:10px;border:1px solid var(--border);
  border-radius:12px;background:#f7f9ff;
}
.msg{max-width:92%; padding:10px 12px; border-radius:12px; margin:8px 0; line-height:1.4; box-shadow:0 4px 14px rgba(15,23,42,.06)}
.msg .meta{font-size:11px;color:var(--muted);margin-bottom:4px}
.msg.you{background:#e8efff}
.msg.other{background:#eef2ff}
.compose{display:flex; gap:8px; margin-top:10px; align-items:flex-end; position:sticky; bottom:0;}
textarea.input{
  flex:1; min-height:46px; max-height:140px; resize:vertical;
  background:#fff; font-size:14px;
}
.emoji-btn{font-size:20px;padding:6px 10px}

/* ===== Partners ===== */
.partner-cta{
  background:linear-gradient(180deg,#e6fbff,#f4fdff);
  border:1px dashed #79d5e4; border-radius:12px; padding:12px; margin-bottom:12px;
}
.partner-card{display:flex;align-items:center;gap:12px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
.partner-card img{width:56px;height:56px;border-radius:12px;border:1px solid var(--border);object-fit:cover}

/* ===== Utility ===== */
.hidden{display:none}
.kv{font-size:12px;color:var(--muted)}
.hr{border:0;border-top:1px solid var(--border);margin:12px 0}
a.link{color:#1f4fd7;text-decoration:none}
a.link:hover{text-decoration:underline}
.small{font-size:12px;color:var(--muted)}
.userchip{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.u-circle{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;background:linear-gradient(135deg,#1d4ed8,#22d3ee)}
.emoji-grid{display:grid;grid-template-columns:repeat(10,28px);gap:6px}
.emoji-grid button{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.emoji-grid img{width:20px;height:20px}
</style>
</head>
<body>

<!-- ===== Topbar ===== -->
<div class="topbar">
  <div class="brand">
    <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="cuG" x1="0" y1="0" x2="40" y2="40"><stop offset="0" stop-color="#1d4ed8"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs>
      <rect width="40" height="40" rx="12" fill="url(#cuG)"/>
      <rect x="8" y="14" width="7" height="16" rx="2" fill="white" opacity=".92"/>
      <rect x="17" y="10" width="7" height="20" rx="2" fill="white" opacity=".92"/>
      <rect x="26" y="16" width="7" height="14" rx="2" fill="white" opacity=".92"/>
    </svg>
    <div class="title">CondUnity ‚Ä¢ Mans√£o Jorge Amado</div>
  </div>
  <div class="who" id="whoami"></div>
</div>

<div class="wrap">

  <!-- Auth -->
  <div class="card section" id="authBox">
    <div class="badge">Dica: use os logins de teste do Supabase (s√≠ndico e morador).</div>
    <div id="authLogged" class="hidden" style="margin-top:10px">
      <span class="badge" id="roleBadge"></span>
      <button class="btn" onclick="logout()">Sair</button>
    </div>
    <div id="authFields" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
      <input id="email" placeholder="Email" class="ghost" style="min-width:220px">
      <input id="password" type="password" placeholder="Senha" class="ghost" style="min-width:160px">
      <button class="btn primary" onclick="login()">Entrar</button>
      <button class="btn" onclick="signup()">Criar conta</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button id="tabBtn-chat" class="active" onclick="openTab('chat')">Chat</button>
    <button id="tabBtn-posts" onclick="openTab('posts')">Comunicados</button>
    <button id="tabBtn-bookings" onclick="openTab('bookings')">Reservas</button>
    <button id="tabBtn-fin" onclick="openTab('fin')">Financeiro</button>
    <button id="tabBtn-ads" onclick="openTab('ads')">Parceiros</button>
    <button id="tabBtn-profile" onclick="openTab('profile')">Perfil</button>
  </div>

  <div class="grid">

    <!-- Coluna Principal -->
    <div class="col-main">

      <!-- Chat -->
      <div class="card section" id="tab-chat">
        <div class="chat-head">
          <h3>Chat Geral do Condom√≠nio</h3>
          <button class="btn" id="btnNotify" onclick="enablePush()">üîî Ativar notifica√ß√µes</button>
        </div>

        <div class="chat-wrap">
          <div id="chatBox" class="chat-box"></div>

          <div class="compose">
            <button class="emoji-btn btn" title="Emojis" onclick="toggleEmoji()">üòä</button>
            <textarea id="chatInput" class="input" placeholder="Escreva uma mensagem‚Ä¶ (Enter envia ‚Ä¢ Shift+Enter quebra linha)"></textarea>
            <button class="btn primary" onclick="sendMessage()">Enviar</button>
          </div>

          <div id="emojiPanel" class="hidden" style="margin-top:8px">
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>
        </div>
      </div>

      <!-- Comunicados -->
      <div class="card section hidden" id="tab-posts">
        <h3>Comunicados</h3>
        <div id="postsList"></div>
        <div id="postForm" class="hidden" style="margin-top:12px">
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <input id="postTitle" style="flex:1" placeholder="T√≠tulo">
            <textarea id="postContent" style="flex:1" placeholder="Conte√∫do"></textarea>
          </div>
          <div style="margin-top:8px"><button class="btn primary" onclick="createPost()">Publicar comunicado</button></div>
        </div>
      </div>

      <!-- Reservas -->
      <div class="card section hidden" id="tab-bookings">
        <h3>Reservas</h3>
        <p class="sub">Integra√ß√£o com o app oficial do condom√≠nio.</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px">
          <button class="btn" onclick="openLogoApp()">Abrir app LOGO (Android)</button>
          <a class="btn" target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=br.com.comunidadesmobile_logoserv&hl=pt-BR">Ir para Play Store</a>
        </div>
        <div id="internalBookings" class="hidden">
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <select id="amenitySelect"></select>
            <input id="startAt" type="datetime-local">
            <input id="endAt" type="datetime-local">
            <button class="btn primary" onclick="requestBooking()">Solicitar</button>
          </div>
          <div id="bookingsList" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- Financeiro -->
      <div class="card section hidden" id="tab-fin">
        <h3>Financeiro</h3>
        <p class="sub">Acesse suas faturas/boletos no sistema atual do condom√≠nio.</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <a class="btn primary" id="btnFinance" target="_blank" rel="noopener" href="#">Abrir Financeiro</a>
        </div>
      </div>

      <!-- Perfil -->
      <div class="card section hidden" id="tab-profile">
        <h3>Perfil</h3>
        <div id="profileInfo"></div>
      </div>

    </div>

    <!-- Coluna Lateral -->
    <div class="col-side">

      <div class="card section" id="tab-ads">
        <h3>Parceiros</h3>

        <div class="partner-cta">
          <strong>üì£ Moradores t√™m prioridade!</strong>
          <div class="small">Divulgue seu neg√≥cio aqui no CondUnity. Prefer√™ncia sempre para moradores do condom√≠nio.</div>
          <div style="margin-top:8px">
            <button class="btn primary" onclick="openPartnerForm()">Divulgar meu neg√≥cio</button>
          </div>
        </div>

        <div id="adsBox" style="display:grid; gap:10px"></div>

        <div id="partnerForm" class="hidden" style="margin-top:12px">
          <h4>Novo parceiro</h4>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <input id="adTitle" style="flex:1" placeholder="T√≠tulo (ex: CEC Tecnologia BA)">
            <input id="adLink"  style="flex:1" placeholder="Link (WhatsApp, site, Instagram‚Ä¶)">
            <input id="adImage" style="flex:1" placeholder="URL da imagem (logo)">
          </div>
          <div style="margin-top:8px"><button class="btn primary" onclick="createPartner()">Publicar parceiro</button></div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = 'https://kqkahzfzxbzqwjtkyqhe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxa2FoemZ6eGJ6cXdqdGt5cWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODk0MTcsImV4cCI6MjA3Mzk2NTQxN30.AyvxACf6RutV35-3gFpUlfutjG9NZzY6ZtCgDijuCrM';
const EDGE_PUSH_URL = 'https://kqkahzfzxbzqwjtkyqhe.functions.supabase.co/push-chat'; // ajuste se precisar
const URL_FINANCEIRO  = 'https://portal.logo.com.br'; // ajuste
// Se tiver VAPID p√∫blica, cole aqui (opcional). Ex: 'BJT...'
const VAPID_PUBLIC_KEY = '';

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Estado ===== */
let session=null, profile=null, condoId=null, generalRoomId=null, isManager=false;
let seenMsgIds = new Set();
let chatChannel = null;
let pollingTimer = null;
let lastSeenAt = null;

const $  = (id)=>document.getElementById(id);
const show = (el)=>el.classList.remove('hidden');
const hide = (el)=>el.classList.add('hidden');

/* ===== UI ===== */
function openTab(k){
  const tabs = ['chat','posts','bookings','fin','ads','profile'];
  tabs.forEach(t => {
    const s=$('tab-'+t), b=$('tabBtn-'+(t==='fin'?'fin':t));
    if(!s||!b) return;
    if(t===k){ show(s); b.classList.add('active'); }
    else { hide(s); b.classList.remove('active'); }
  });
}

function initials(s){ s=(s||'').trim(); if(!s) return '?'; const p=s.split(/\s+/).slice(0,2); return p.map(x=>x[0]?.toUpperCase()||'').join(''); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function fmt(s){ try{return new Date(s).toLocaleString('pt-BR')}catch{return s} }

function updateAuthUI(logged, name='', roleLabel=''){
  if (logged){
    hide($('authFields')); show($('authLogged'));
    $('whoami').innerHTML = `<div class="userchip"><div class="u-circle">${initials(name)}</div><div>${escapeHtml(name)} <span class="small">‚Ä¢ ${roleLabel}</span></div></div>`;
  }else{
    show($('authFields')); hide($('authLogged')); $('whoami').innerHTML='';
  }
}

/* ===== Auth ===== */
async function login(){
  try{
    const { data, error } = await client.auth.signInWithPassword({ email:$('email').value, password:$('password').value });
    if(error) throw error; session=data.session; $('password').value=''; await boot();
  }catch(e){ alert('Falha no login: '+(e?.message||e)); }
}
async function signup(){
  try{
    const { error } = await client.auth.signUp({ email:$('email').value, password:$('password').value });
    if(error) throw error; alert('Conta criada! (piloto: Confirm email desativado)');
  }catch(e){ alert('Erro no cadastro: '+(e?.message||e)); }
}
async function logout(){ await client.auth.signOut(); location.reload(); }

/* ===== App Boot ===== */
async function boot(){
  const { data: auth } = await client.auth.getUser();
  const uid = auth?.user?.id;
  const email = auth?.user?.email || '';
  if(!uid){ updateAuthUI(false); return; }

  const { data: me, error:eProf } = await client.from('profiles')
    .select('id, full_name, role, condominium_id, unit_id')
    .eq('id', uid).single();
  if(eProf){ alert('Erro ao ler perfil: '+eProf.message); return; }
  profile = me; condoId = me.condominium_id; isManager = (me.role==='manager'||me.role==='admin');

  const name = (me?.full_name?.trim()) || email.split('@')[0];
  $('roleBadge').innerText = isManager ? 'Manager' : 'Resident';
  updateAuthUI(true, name, isManager?'Manager':'Resident');

  const { data: room, error:eRoom } = await client.from('chat_rooms').select('id').eq('name','Geral').single();
  if(eRoom){ alert('Sala de chat n√£o encontrada'); return; }
  generalRoomId = room.id;

  $('btnFinance').href = URL_FINANCEIRO;

  await loadChat();
  subscribeChatRealtime(); // listener robusto
  await loadPosts(); await loadAmenities(); await loadBookings(); await loadAds();

  $('profileInfo').innerHTML = `
    <div class="partner-card" style="align-items:center"><div class="u-circle">${initials(name)}</div>
      <div>
        <div><strong>${escapeHtml(name)}</strong></div>
        <div class="small">Role: ${me?.role} ‚Ä¢ Unidade: ${me?.unit_id||'-'}</div>
      </div>
    </div>`;

  if (isManager) show($('partnerForm')); else hide($('partnerForm'));
}

/* ===== Chat: listagem e envio ===== */
function renderEmojiIn(el){ if(window.twemoji){ twemoji.parse(el, {folder:'svg', ext:'.svg'}); } }

function makeMsgBubble(m){
  const you = (profile?.id && m.sender_id && profile.id===m.sender_id);
  const div = document.createElement('div');
  div.className = 'msg ' + (you?'you':'other');
  div.innerHTML = `<div class="meta">${escapeHtml(m.sender_name||'Morador')} ‚Ä¢ ${fmt(m.created_at)}</div><span class="__msg">${escapeHtml(m.content)}</span>`;
  // parse emojis para <img> (Twemoji)
  renderEmojiIn(div);
  return div;
}
async function loadChat(){
  const { data, error } = await client.from('chat_messages')
    .select('id, content, created_at, room_id, sender_name, sender_id')
    .eq('room_id', generalRoomId)
    .order('created_at',{ascending:true})
    .limit(300);
  if(error){ $('chatBox').innerHTML='<div class="small">Erro ao carregar chat.</div>'; return; }
  seenMsgIds = new Set();
  const box = $('chatBox'); box.innerHTML='';
  (data||[]).forEach(m=>{ if(m?.id) seenMsgIds.add(m.id); box.appendChild(makeMsgBubble(m)); });
  box.scrollTop = box.scrollHeight;
  const last = (data||[]).slice(-1)[0]; if(last) lastSeenAt = last.created_at;
}

async function sendMessage(){
  const text = $('chatInput').value.trim(); if(!text) return;

  const user = (await client.auth.getUser()).data.user;
  const displayName = (profile?.full_name?.trim()) || (user?.email?.split('@')[0] || 'Morador');

  const { data, error } = await client.from('chat_messages')
    .insert({ room_id: generalRoomId, content: text, sender_id: profile?.id || user?.id || null, sender_name: displayName })
    .select('id, content, created_at, room_id, sender_name, sender_id')
    .single();

  if(error){ alert('Erro ao enviar: '+error.message); return; }

  $('chatInput').value='';
  appendMsg(data); // otimista

  // dispara push (n√£o bloqueia UI)
  fetch(EDGE_PUSH_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) }).catch(()=>{});
}

function appendMsg(m){
  if (!m || !m.id || seenMsgIds.has(m.id)) return;
  seenMsgIds.add(m.id);
  $('chatBox').appendChild(makeMsgBubble(m));
  $('chatBox').scrollTop = $('chatBox').scrollHeight;
  lastSeenAt = m.created_at || lastSeenAt;
}

/* ===== Chat: Realtime forte (corrige celular -> desktop) ===== */
function subscribeChatRealtime(){
  // limpa subs anteriores
  if (chatChannel){ try{ client.removeChannel(chatChannel); }catch{} chatChannel=null; }
  if (pollingTimer){ clearInterval(pollingTimer); pollingTimer=null; }

  chatChannel = client.channel('realtime:chat_messages:'+generalRoomId);

  chatChannel.on('postgres_changes',
    { event:'INSERT', schema:'public', table:'chat_messages', filter: `room_id=eq.${generalRoomId}` },
    payload => { const m = payload.new; appendMsg(m); }
  );

  chatChannel.subscribe(status => {
    if (status === 'SUBSCRIBED'){
      if (pollingTimer){ clearInterval(pollingTimer); pollingTimer=null; }
    }
    if (status === 'CLOSED' || status === 'TIMED_OUT' || status === 'CHANNEL_ERROR'){
      if (!pollingTimer){ pollingTimer = setInterval(()=>refreshSince(), 2000); }
    }
  });
}

// busca mensagens novas (fallback)
async function refreshSince(){
  const since = lastSeenAt || new Date(Date.now()-1000*60*10).toISOString();
  const { data } = await client.from('chat_messages')
    .select('id, content, created_at, room_id, sender_name, sender_id')
    .eq('room_id', generalRoomId)
    .gt('created_at', since)
    .order('created_at',{ascending:true})
    .limit(50);
  (data||[]).forEach(m=>appendMsg(m));
}

// textarea: Enter envia / Shift+Enter quebra linha
(function(){
  const input = $('chatInput');
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault(); sendMessage();
    }
  });
})();

/* ===== Emoji Picker (Twemoji imagens) ===== */
const EMOJIS = ["üòÄ","üòÅ","üòÇ","ü§£","üòä","üôÇ","üòâ","üòç","üòò","üòé","üò¢","üò≠","üò°","üëç","üëé","üëè","üôè","üí™","üî•","üéâ","‚ú®","üåü","üí°","üìå","üìé","üì≤","üè†","üöó","üçï","üçî","‚òï"];
function renderEmojiGrid(){
  const grid=$('emojiGrid'); grid.innerHTML='';
  EMOJIS.forEach(ch=>{
    const btn=document.createElement('button');
    btn.innerHTML = ch; // texto primeiro‚Ä¶
    grid.appendChild(btn);
    btn.onclick=()=>{ const t=$('chatInput'); t.value=(t.value||'')+ch; t.focus(); };
  });
  // ‚Ä¶depois converte pra imagens twemoji (garante sem quadradinhos)
  if(window.twemoji){ twemoji.parse(grid, {folder:'svg', ext:'.svg'}); }
}
function toggleEmoji(){ const p=$('emojiPanel'); p.classList.toggle('hidden'); if(!p.dataset.rendered){ renderEmojiGrid(); p.dataset.rendered='1'; } }

/* ===== Posts ===== */
async function loadPosts(){
  const { data, error } = await client.from('posts')
    .select('id,title,content,created_at')
    .eq('condominium_id', condoId)
    .order('created_at',{ascending:false}).limit(50);
  if(error){ $('postsList').innerHTML='<div class="small">Sem permiss√£o para ler comunicados.</div>'; return; }
  $('postsList').innerHTML = (data||[]).map(p=>`
    <div class="partner-card" style="align-items:flex-start">
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(p.title)}</div>
        <div class="small">${fmt(p.created_at)}</div>
        <div style="margin-top:4px"><span class="__msg">${escapeHtml(p.content)}</span></div>
      </div>
    </div>`).join('');
  if (isManager) show($('postForm')); else hide($('postForm'));
  renderEmojiIn($('postsList'));
}
async function createPost(){
  const title=$('postTitle').value.trim(), content=$('postContent').value.trim();
  if(!title||!content){ alert('Preencha t√≠tulo e conte√∫do'); return; }
  const { error } = await client.from('posts').insert({ condominium_id: condoId, author_id: profile.id, title, content });
  if(error){ alert('Erro ao publicar: '+error.message); return; }
  $('postTitle').value=''; $('postContent').value=''; loadPosts();
}

/* ===== Reservas (interno opcional) ===== */
async function loadAmenities(){
  const { data } = await client.from('amenities').select('id,name').eq('condominium_id', condoId).order('name');
  $('amenitySelect').innerHTML = (data||[]).map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
}
async function requestBooking(){
  const amenity_id=$('amenitySelect').value;
  const starts_at=$('startAt').value? new Date($('startAt').value).toISOString():null;
  const ends_at=$('endAt').value? new Date($('endAt').value).toISOString():null;
  if(!amenity_id||!starts_at||!ends_at){ alert('Preencha √°rea e hor√°rios'); return; }
  const { error } = await client.from('bookings').insert({ condominium_id:condoId, amenity_id, requester_id: profile.id, starts_at, ends_at });
  if(error){ alert('Erro ao solicitar: '+error.message); return; }
  loadBookings();
}
async function loadBookings(){
  const list=$('bookingsList'); if(!list) return;
  const { data } = await client.from('bookings')
    .select('id,amenity_id,starts_at,ends_at,status')
    .eq('condominium_id',condoId).order('starts_at',{ascending:false}).limit(50);
  list.innerHTML=(data||[]).map(b=>{
    const actions=(isManager && b.status==='pending')
      ? `<button class="btn" onclick="setBooking('${b.id}','approved')">Aprovar</button>
         <button class="btn" onclick="setBooking('${b.id}','rejected')">Rejeitar</button>`
      : `<span class="badge">${b.status}</span>`;
    return `<div class="partner-card"><div style="flex:1">
      <div><strong>${escapeHtml(b.amenity_id)}</strong></div>
      <div class="small">${fmt(b.starts_at)} ‚Üí ${fmt(b.ends_at)}</div></div>${actions}</div>`;
  }).join('');
}
async function setBooking(id,status){
  const { error } = await client.from('bookings').update({ status }).eq('id', id);
  if(error){ alert('Erro ao atualizar: '+error.message); return; }
  loadBookings();
}

/* ===== Parceiros ===== */
function openPartnerForm(){ if(isManager) show($('partnerForm')); else alert('Somente Manager pode publicar.'); }
async function loadAds(){
  const now = new Date().toISOString();
  const { data, error } = await client.from('partner_ads')
    .select('title,image_url,link_url,priority,starts_at,ends_at,is_active')
    .eq('condominium_id', condoId)
    .order('priority',{ascending:false});
  if (error){ $('adsBox').innerHTML='<div class="small">N√£o foi poss√≠vel carregar os parceiros.</div>'; return; }
  let items = (data||[]).filter(a=> a.is_active && (!a.starts_at || a.starts_at<=now) && (!a.ends_at || a.ends_at>=now));
  if (!items.length){
    items = [{ title:'CEC Tecnologia BA ‚Äî Manuten√ß√£o de Computadores e Celulares', image_url:'cec-logo.png', link_url:'https://wa.me/5571999999999' }];
  }
  $('adsBox').innerHTML = items.map(a=>`
    <div class="partner-card">
      <img src="${a.image_url||'cec-logo.png'}" onerror="this.src='cec-logo.png'">
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(a.title)}</div>
        <div class="small">Prefer√™ncia para moradores</div>
      </div>
      <a class="btn" href="${a.link_url||'#'}" target="_blank" rel="noopener">Fale agora</a>
    </div>`).join('');
}

/* ===== Deep-link Android LOGO ===== */
function openLogoApp(){
  const pkg='br.com.comunidadesmobile_logoserv';
  const deep='logoserv://open';
  const store='https://play.google.com/store/apps/details?id='+pkg;
  const isAndroid=/Android/i.test(navigator.userAgent);
  if(isAndroid){
    const iframe=document.createElement('iframe'); iframe.style.display='none'; iframe.src=deep; document.body.appendChild(iframe);
    setTimeout(()=>{ window.location.href=store; }, 1200);
    setTimeout(()=>{ document.body.removeChild(iframe); }, 2000);
  } else { window.open(store,'_blank'); }
}

/* ===== Push: inscri√ß√£o ===== */
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64); const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}
async function enablePush(){
  try{
    if(!('serviceWorker' in navigator)) return alert('Service Worker indispon√≠vel.');
    const reg = await navigator.serviceWorker.register('./sw.js'); await navigator.serviceWorker.ready;

    const perm = await Notification.requestPermission();
    if(perm!=='granted'){ alert('Notifica√ß√µes bloqueadas.'); return; }

    const appKey = VAPID_PUBLIC_KEY ? urlBase64ToUint8Array(VAPID_PUBLIC_KEY) : undefined;
    const sub = await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: appKey });
    if(!sub) return alert('Falha ao inscrever.');

    const { endpoint, keys } = sub.toJSON();
    await client.from('push_subscriptions').upsert({
      endpoint, keys_p256dh: keys?.p256dh || null, keys_auth: keys?.auth || null, user_id: profile?.id || null
    });
    $('btnNotify').textContent='üîî Notifica√ß√µes ativas';
  }catch(e){ alert('Falha ao ativar: '+(e?.message||e)); }
}

/* ===== Start ===== */
(async()=>{
  const { data } = await client.auth.getSession();
  if(data.session){ await boot(); } else { updateAuthUI(false); }
})();
</script>

<!-- SW register -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js'); });
}
</script>

</body>
</html>
