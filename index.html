<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CondUnity - Mans√£o Jorge Amado</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json" />
<link rel="icon" href="favicon.ico" />
<meta name="theme-color" content="#2563eb" />
<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="apple-touch-icon" href="./icon-192.png" />

<style>
:root{--bg:#f7f9fc;--card:#ffffff;--text:#0f172a;--muted:#475569;--primary:#2563eb}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
.header{padding:18px 16px;display:flex;align-items:center;gap:12px;background:#fff;border-bottom:1px solid #eef2f7;position:sticky;top:0;z-index:10}
.logo{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center}
.title{font-size:20px;font-weight:700;letter-spacing:.2px}
.userchip{display:flex;align-items:center;gap:10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px}
.userchip .circle{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;background:linear-gradient(135deg,#1d4ed8,#22d3ee)}
.userchip .name{font-weight:600}
.userchip .role{font-size:12px;color:#64748b;margin-left:4px}
.container{max-width:1120px;margin:24px auto;padding:0 16px}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.nav button{padding:10px 14px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;cursor:pointer;font-weight:600}
.nav button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 6px 18px rgba(15,23,42,.04)}
.row{display:flex;gap:10px;flex-wrap:wrap}
input,select,textarea{padding:10px 12px;border:1px solid #cbd5e1;border-radius:12px;font-size:14px}
input:focus,textarea:focus,select:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 3px rgba(37,99,235,.12)}
button.primary{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn{padding:10px 14px;border:1px solid #e2e8f0;border-radius:12px;background:#fff;cursor:pointer;font-weight:600}
.badge{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;color:#334155;background:#f8fafc}
.hidden{display:none}
.list{display:grid;gap:10px}
.item{padding:12px;border:1px solid #e2e8f0;border-radius:12px;background:#fff}
.kv{font-size:12px;color:var(--muted)}
.sidebar{min-width:300px}
.flex{display:flex;gap:16px}
.flex-1{flex:1}
@media (max-width: 900px){ .flex{flex-direction:column}.sidebar{min-width:auto} }
.chat-box{height:300px;overflow:auto;border:1px solid #e2e8f0;border-radius:12px;padding:10px;background:#f8fafc}
.msg{padding:8px 10px;border-radius:12px;background:#eef2ff;margin-bottom:8px;line-height:1.35}
hr.sep{border:0;border-top:1px solid #e2e8f0;margin:12px 0}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.partner-card{display:flex;gap:12px;align-items:center}
.partner-card img{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid #e2e8f0}
.partner-card .info{flex:1}
.partner-card .title{font-weight:700}
.partner-card .sub{font-size:12px;color:#64748b;margin-top:2px}
.small{font-size:12px;color:#64748b}

/* Banner de instala√ß√£o */
.install-banner{position:fixed;left:12px;right:12px;bottom:12px;z-index:50;background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:12px 14px;box-shadow:0 10px 24px rgba(15,23,42,.12);display:none}
.install-banner .title{font-weight:700}
.install-banner .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.install-banner .hint{font-size:12px;color:#64748b}
.install-banner .actions{display:flex;gap:8px}
.install-banner .xbtn{background:transparent;border:none;cursor:pointer;font-size:18px;line-height:1}

/* Emoji picker simples */
.emoji-toggle{border:1px solid #e2e8f0;background:#fff;border-radius:12px;padding:0 10px;font-size:20px;cursor:pointer}
.emoji-panel{position:absolute;bottom:54px;right:16px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:8px;display:none;box-shadow:0 8px 20px rgba(15,23,42,.12);max-width:280px}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;font-size:22px}
.chat-row{display:flex;gap:8px;align-items:center;position:relative}
</style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block;border-radius:12px">
        <defs><linearGradient id="cuG" x1="0" y1="0" x2="40" y2="40"><stop offset="0" stop-color="#1d4ed8"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs>
        <rect width="40" height="40" rx="12" fill="url(#cuG)"/>
        <rect x="8" y="14" width="7" height="16" rx="2" fill="white" opacity=".9"/>
        <rect x="17" y="10" width="7" height="20" rx="2" fill="white" opacity=".9"/>
        <rect x="26" y="16" width="7" height="14" rx="2" fill="white" opacity=".9"/>
        <path d="M11 14 v9 c0 5 4 7 9 7s9-2 9-7v-9" stroke="#0ea5e9" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="title">CondUnity ‚Ä¢ Mans√£o Jorge Amado</div>
    <div style="margin-left:auto" id="whoami"></div>
  </header>

  <div class="container">
    <!-- LOGIN -->
    <div class="card" id="authBox">
      <div class="row" id="authFields">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Senha">
        <button class="primary" onclick="login()">Entrar</button>
        <button class="btn" onclick="signup()">Criar conta</button>
      </div>
      <div class="row hidden" id="authLogged">
        <span class="badge" id="roleBadge"></span>
        <button class="btn" onclick="logout()">Sair</button>
      </div>
      <div class="small">Dica: use os logins de teste do Supabase (s√≠ndico e morador).</div>
    </div>

    <div class="nav">
      <button id="tabBtn-chat" class="active" onclick="openTab('chat')">Chat</button>
      <button id="tabBtn-posts" onclick="openTab('posts')">Comunicados</button>
      <button id="tabBtn-bookings" onclick="openTab('bookings')">Reservas</button>
      <button id="tabBtn-finance" onclick="openTab('finance')">Financeiro</button>
      <button id="tabBtn-ads" onclick="openTab('ads')">Parceiros</button>
      <button id="tabBtn-profile" onclick="openTab('profile')">Perfil</button>
    </div>

    <div class="flex">
      <div class="flex-1">
        <!-- CHAT -->
        <section id="tab-chat" class="card">
          <h3 style="display:flex;align-items:center;gap:10px">
            Chat Geral do Condom√≠nio
            <button class="btn" id="notifyBtn" style="margin-left:auto">üîî Ativar notifica√ß√µes</button>
          </h3>
          <div id="chatBox" class="chat-box"></div>
          <div class="chat-row" style="margin-top:8px">
            <button class="emoji-toggle" id="emojiToggle" title="Emojis">üòä</button>
            <input id="chatInput" class="flex-1" placeholder="Escreva uma mensagem... (Enter envia, Shift+Enter quebra linha)">
            <button class="primary" onclick="sendMessage()">Enviar</button>
            <div id="emojiPanel" class="emoji-panel"><div class="emoji-grid" id="emojiGrid"></div></div>
          </div>
        </section>

        <!-- POSTS (integra√ß√£o externa opcional) -->
        <section id="tab-posts" class="card hidden">
          <h3>Comunicados</h3>
          <div class="grid2" style="margin-bottom:10px">
            <a class="btn" id="openExternalNews" href="#" target="_blank" rel="noopener">Abrir comunicados no app atual</a>
            <button class="btn" onclick="syncNewsInfo()">Como integrar automaticamente</button>
          </div>
          <div id="postsList" class="list"></div>
          <div id="postForm" class="card hidden" style="margin-top:10px">
            <div class="row"><input id="postTitle" class="flex-1" placeholder="T√≠tulo"></div>
            <div class="row"><textarea id="postContent" class="flex-1" placeholder="Conte√∫do"></textarea></div>
            <button class="primary" onclick="createPost()">Publicar comunicado</button>
          </div>
        </section>

        <!-- BOOKINGS (integra√ß√£o) -->
        <section id="tab-bookings" class="card hidden">
          <h3>Reservas</h3>
          <div class="grid2">
            <button class="btn" onclick="openLogoApp()">Abrir app LOGO (Android)</button>
            <a class="btn" id="openExternalBookings" href="#" target="_blank" rel="noopener">Abrir reservas no app atual</a>
          </div>
          <hr class="sep">
          <div id="internalBookings" class="hidden">
            <div class="row">
              <select id="amenitySelect"></select>
              <input id="startAt" type="datetime-local">
              <input id="endAt" type="datetime-local">
              <button class="primary" onclick="requestBooking()">Solicitar</button>
            </div>
            <div id="bookingsList" class="list" style="margin-top:10px"></div>
          </div>
        </section>

        <!-- FINANCE (integra√ß√£o) -->
        <section id="tab-finance" class="card hidden">
          <h3>Financeiro do seu apartamento</h3>
          <div class="grid2">
            <a class="btn" id="openExternalBills" href="#" target="_blank" rel="noopener">Abrir financeiro no app atual</a>
            <button class="btn" onclick="explainBillingIntegration()">Como integrar automaticamente</button>
          </div>
          <div id="invoicesList" class="list" style="margin-top:12px"></div>
        </section>

        <!-- PROFILE -->
        <section id="tab-profile" class="card hidden">
          <h3>Perfil</h3>
          <div id="profileInfo"></div>
        </section>
      </div>

      <!-- ADS / PARCEIROS -->
      <aside class="sidebar">
        <section id="tab-ads" class="card">
          <h3>Parceiros</h3>
          <div class="item">
            <div style="font-weight:700; font-size:15px">üì£ Moradores t√™m prioridade!</div>
            <div class="small" style="margin:6px 0 10px">
              Divulgue seu neg√≥cio aqui no CondUnity. Prioridade sempre para moradores do condom√≠nio.
            </div>
            <button class="primary" onclick="togglePartnerForm()">Divulgar meu neg√≥cio</button>
          </div>
          <div id="adsBox" class="list" style="margin-top:10px"></div>
          <div id="partnerForm" class="hidden" style="margin-top:12px">
            <h4>Cadastrar parceiro</h4>
            <div class="row"><input id="adTitle" class="flex-1" placeholder="T√≠tulo (ex: CEC Tecnologia BA)"></div>
            <div class="row"><input id="adLink" class="flex-1" placeholder="Link (WhatsApp, site, instagram...)"></div>
            <div class="row"><input id="adImage" class="flex-1" placeholder="URL da imagem (logo)"></div>
            <div class="small">Moradores: seu an√∫ncio entra como <b>aguardando aprova√ß√£o</b>.</div>
            <button class="primary" onclick="createPartner()">Enviar para publica√ß√£o</button>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- Banner de instala√ß√£o -->
  <div id="installBanner" class="install-banner" role="region" aria-live="polite">
    <div class="row">
      <div>
        <div class="title">Instale o CondUnity no seu aparelho</div>
        <div id="installHint" class="hint"></div>
      </div>
      <div class="actions">
        <button id="installBtn" class="primary">Instalar agora</button>
        <button class="xbtn" aria-label="Fechar" onclick="hideInstallBanner()">‚úï</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  /* =========================
     CONFIGURA√á√ïES R√ÅPIDAS
  ==========================*/
  // Supabase
  const SUPABASE_URL = 'https://kqkahzfzxbzqwjtkyqhe.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxa2FoemZ6eGJ6cXdqdGt5cWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODk0MTcsImV4cCI6MjA3Mzk2NTQxN30.AyvxACf6RutV35-3gFpUlfutjG9NZzY6ZtCgDijuCrM';

  // Deep links/URLs dos sistemas existentes (ajuste como preferir)
  const DEEPLINK_LOGO = 'logoserv://open';
  const PLAY_LOGO = 'https://play.google.com/store/apps/details?id=br.com.comunidadesmobile_logoserv';
  const URL_COMUNICADOS = 'logoserv://news';   // ou https://...
  const URL_FINANCEIRO  = 'logoserv://finance';// ou https://...

  // Push (Web Push) ‚Äì gere e coloque sua PUBLIC VAPID KEY aqui quando tiver
  // Sem isso, o bot√£o ‚ÄúAtivar notifica√ß√µes‚Äù vai mostrar instru√ß√µes.
  const VAPID_PUBLIC_KEY = 'BI9aR9_W97QuSa6CELRWbuvz2H1thSeLZhVmWn11ecgvLqwRWc7ixKuL2ba99H_sV4Jl4M1nAEK6KgPXMeADOn0'; // ex: 'BElQ3...'

  /* =========================
     APP
  ==========================*/
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true },
    realtime: { params: { eventsPerSecond: 20 } }
  });

  let profile=null, condoId=null, generalRoomId=null, isManager=false;
  let chatChannel = null, rtConnected=false, pollTimer=null;
  const seenMsgIds = new Set();

  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  function openTab(k){
    ['chat','posts','bookings','finance','ads','profile'].forEach(t=>{
      const s=$('tab-'+t), b=$('tabBtn-'+t);
      if(s && b){ if(t===k){show(s); b.classList.add('active')} else {hide(s); b.classList.remove('active')} }
    });
  }

  function updateAuthUI(logged, displayName='', roleLabel=''){
    if (logged){
      hide($('authFields')); show($('authLogged'));
      $('whoami').innerHTML =
        `<div class="userchip">
           <div class="circle">${initials(displayName)}</div>
           <div class="name">${escapeHtml(displayName)}<span class="role"> ‚Ä¢ ${roleLabel}</span></div>
         </div>`;
    }else{
      show($('authFields')); hide($('authLogged')); $('whoami').innerHTML='';
    }
  }
  const initials = (s) => { s=(s||'').trim(); if(!s) return '?'; const p=s.split(/\s+/).slice(0,2); return p.map(x=>x[0]?.toUpperCase()||'').join(''); };

  function appendMsg(m){
    if(!m) return;
    if (m.id && seenMsgIds.has(m.id)) return;
    if (m.id) seenMsgIds.add(m.id);
    const who = m.sender_name ? `<strong>${escapeHtml(m.sender_name)}</strong> ‚Ä¢ ` : '';
    const div = document.createElement('div');
    div.className='msg';
    div.innerHTML = `<span class="kv">${who}${new Date(m.created_at||Date.now()).toLocaleString('pt-BR')}</span><br>${escapeHtml(m.content||'')}`;
    $('chatBox').appendChild(div);
    $('chatBox').scrollTop = $('chatBox').scrollHeight;
  }

  async function login(){
    try{
      const { data, error } = await client.auth.signInWithPassword({ email:$('email').value, password:$('password').value });
      if(error) throw error; $('password').value=''; await boot();
    }catch(e){ alert('Falha no login: ' + (e?.message || e)); }
  }
  async function signup(){
    try{ const { error } = await client.auth.signUp({ email:$('email').value, password:$('password').value }); if(error) throw error; alert('Conta criada!'); }
    catch(e){ alert('Erro no cadastro: '+(e?.message||e)); }
  }
  async function logout(){ await client.auth.signOut(); $('password').value=''; updateAuthUI(false); location.reload(); }

  async function boot(){
    // links integra√ß√µes
    setupExternalButtons();

    const { data: userData } = await client.auth.getUser();
    const uid = userData?.user?.id; const email = userData?.user?.email || '';
    if(!uid){ updateAuthUI(false); return; }

    const { data: me, error: eProf } = await client.from('profiles')
      .select('id, full_name, role, condominium_id, unit_id')
      .eq('id', uid).single();
    if(eProf){ alert('Erro ao ler perfil: '+eProf.message); return; }

    profile = me; condoId = me.condominium_id; isManager = (me.role==='manager' || me.role==='admin');
    const displayName = (me?.full_name && me.full_name.trim()) || email.split('@')[0];
    const roleLabel = isManager ? 'Manager' : 'Resident';
    $('roleBadge').innerText = roleLabel; updateAuthUI(true, displayName, roleLabel);

    const { data: room, error: eRoom } = await client.from('chat_rooms').select('id').eq('name','Geral').single();
    if(eRoom){ alert('Sala de chat n√£o encontrada'); return; }
    generalRoomId = room.id;

    await loadChat();
    startRealtime();         // realtime + watchdog
    await loadPosts(); await loadAmenities(); await loadBookings(); await loadAds(); await loadInvoices();

    $('profileInfo').innerHTML = `
      <div class="item"><div><strong>Nome:</strong> ${escapeHtml(displayName)}</div>
      <div><strong>Role:</strong> ${me?.role}</div>
      <div><strong>Unidade:</strong> ${me?.unit_id || '-'}</div></div>`;
  }

  /* ---------- CHAT ---------- */
  async function loadChat(){
    const { data, error } = await client
      .from('chat_messages')
      .select('id, content, created_at, room_id, sender_name')
      .eq('room_id', generalRoomId)
      .order('created_at',{ascending:true})
      .limit(200);
    if(error){ alert('Erro ao carregar chat: '+error.message); return; }
    seenMsgIds.clear(); $('chatBox').innerHTML=''; (data||[]).forEach(appendMsg);
  }

  async function sendMessage(){
    const input = $('chatInput'); const text = input.value.trim(); if(!text) return;
    const displayName = (profile?.full_name && profile.full_name.trim()) || (await (await client.auth.getUser()).data.user.email.split('@')[0]);
    const temp = { id:'tmp-'+Math.random().toString(36).slice(2), content:text, created_at:new Date().toISOString(), sender_name:displayName };
    appendMsg(temp); input.value='';
    const { error } = await client.from('chat_messages')
      .insert({ room_id: generalRoomId, content: text, sender_id: profile?.id || null, sender_name: displayName });
    if(error){ alert('Erro ao enviar: '+error.message); await loadChat(); }
  }

  // Enter envia; Shift+Enter quebra linha
  (function(){
    const input=$('chatInput');
    input.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
  })();

  // Realtime + watchdog + fallback polling
  function startRealtime(){
    if (chatChannel) { client.removeChannel(chatChannel); chatChannel=null; }
    chatChannel = client.channel('room:'+generalRoomId)
      .on('postgres_changes',{ event:'INSERT', schema:'public', table:'chat_messages', filter:`room_id=eq.${generalRoomId}` }, (payload)=>{ rtConnected=true; appendMsg(payload.new); })
      .subscribe(status=>{
        rtConnected = (status==='SUBSCRIBED');
      });

    // Watchdog: verifica conex√£o e liga polling se cair
    if (pollTimer) clearInterval(pollTimer);
    let lastReload = 0;
    pollTimer = setInterval(async ()=>{
      const now = Date.now();
      // se rt caiu, busca √∫ltimas mensagens
      if(!rtConnected){
        await loadChat();
      }
      // ping: for√ßa re-subscribe se ficar 30s sem RT
      if(!rtConnected && now-lastReload>30000){
        lastReload = now; startRealtime();
      }
    }, 3000);
  }

  /* ---------- POSTS ---------- */
  async function loadPosts(){
    const { data, error } = await client.from('posts')
      .select('id,title,content,created_at')
      .eq('condominium_id', condoId)
      .order('created_at',{ascending:false})
      .limit(50);
    if(error){ $('postsList').innerHTML='<div class="item">Sem permiss√£o para ler comunicados.</div>'; return; }
    $('postsList').innerHTML = (data||[]).map(p=>`<div class="item"><div style="font-weight:700">${escapeHtml(p.title)}</div><div class="kv">${new Date(p.created_at).toLocaleString('pt-BR')}</div><div>${escapeHtml(p.content)}</div></div>`).join('');
  }
  async function createPost(){
    const title = $('postTitle').value.trim(), content = $('postContent').value.trim();
    if(!title||!content){ alert('Preencha t√≠tulo e conte√∫do'); return; }
    const { error } = await client.from('posts').insert({ condominium_id: condoId, author_id: profile.id, title, content });
    if(error){ alert('Erro ao publicar: '+error.message); return; }
    $('postTitle').value=''; $('postContent').value=''; await loadPosts();
  }

  /* ---------- RESERVAS ---------- */
  async function loadAmenities(){
    const el=$('amenitySelect'); if(!el) return;
    const { data } = await client.from('amenities').select('id,name').eq('condominium_id', condoId).order('name');
    el.innerHTML = (data||[]).map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
  }
  async function requestBooking(){
    const amenity_id=$('amenitySelect').value;
    const starts_at=$('startAt').value?new Date($('startAt').value).toISOString():null;
    const ends_at=$('endAt').value?new Date($('endAt').value).toISOString():null;
    if(!amenity_id||!starts_at||!ends_at){ alert('Preencha √°rea e hor√°rios'); return; }
    const { error } = await client.from('bookings').insert({ condominium_id: condoId, amenity_id, requester_id: profile.id, starts_at, ends_at });
    if(error){ alert('Erro ao solicitar: '+error.message); return; }
    await loadBookings();
  }
  async function loadBookings(){
    const list=$('bookingsList'); if(!list) return;
    const { data } = await client.from('bookings')
      .select('id,amenity_id,starts_at,ends_at,status')
      .eq('condominium_id', condoId).order('starts_at',{ascending:false}).limit(50);
    list.innerHTML = (data||[]).map(b=>{
      const actions = (isManager && b.status==='pending')
        ? `<button onclick="setBooking('${b.id}','approved')">Aprovar</button> <button onclick="setBooking('${b.id}','rejected')">Rejeitar</button>`
        : `<span class="badge">${b.status}</span>`;
      return `<div class="item"><div><strong>${b.amenity_id}</strong></div><div class="kv">${fmt(b.starts_at)} ‚Üí ${fmt(b.ends_at)}</div><div>${actions}</div></div>`;
    }).join('');
  }
  async function setBooking(id,status){ const { error } = await client.from('bookings').update({ status }).eq('id', id); if(!error) await loadBookings(); }

  /* ---------- PARCEIROS ---------- */
  function togglePartnerForm(){ const f=$('partnerForm'); if(!f) return; f.classList.toggle('hidden'); }
  async function loadAds(){
    const now = new Date().toISOString();
    const { data, error } = await client.from('partner_ads')
      .select('title,image_url,link_url,priority,starts_at,ends_at,is_active')
      .eq('condominium_id', condoId).order('priority',{ascending:false});
    if (error){ $('adsBox').innerHTML='<div class="item">N√£o foi poss√≠vel carregar os parceiros.</div>'; return; }
    let items=(data||[]).filter(a=> a.is_active && (!a.starts_at||a.starts_at<=now) && (!a.ends_at||a.ends_at>=now));
    if(!items.length){ items=[{title:'CEC Tecnologia BA ‚Äî Manuten√ß√£o de Computadores e Celulares', image_url:'cec-logo.png', link_url:'https://wa.me/5571999999999'}]; }
    $('adsBox').innerHTML = items.map(a=>`
      <div class="item partner-card">
        <img src="${a.image_url || 'cec-logo.png'}" alt="${escapeHtml(a.title)}" onerror="this.src='cec-logo.png'">
        <div class="info"><div class="title">${escapeHtml(a.title)}</div><div class="sub">Prefer√™ncia para moradores</div></div>
        <a class="btn" href="${a.link_url||'#'}" target="_blank" rel="noopener">Fale agora</a>
      </div>`).join('');
  }
  async function createPartner(){
    const title=$('adTitle').value.trim(); const link=$('adLink').value.trim(); const image=$('adImage').value.trim();
    if(!profile){ alert('Fa√ßa login para cadastrar.'); return; }
    if(!title){ alert('Informe o t√≠tulo'); return; }
    const rec={ title, link_url:link||null, image_url:image||null, is_active:(isManager?true:false), priority:10, condominium_id:condoId, owner_id:profile.id||null };
    const { error } = await client.from('partner_ads').insert(rec);
    if(error){ alert('Erro ao cadastrar parceiro: '+error.message); return; }
    $('adTitle').value=''; $('adLink').value=''; $('adImage').value='';
    if(isManager) await loadAds(); else alert('Enviado! Aguarde aprova√ß√£o.');
  }

  /* ---------- FINANCE / INVOICES ---------- */
  async function loadInvoices(){
    try{
      const { data, error } = await client.from('invoices')
        .select('id, month, year, amount_cents, status, billet_url, unit_id')
        .eq('unit_id', profile.unit_id).order('year',{ascending:false}).order('month',{ascending:false}).limit(24);
      if(error) throw error;
      const list = (data||[]);
      $('invoicesList').innerHTML = list.length ? list.map(i=>{
        const v=(i.amount_cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        const st=i.status==='paid'?'‚úÖ Pago':(i.status==='overdue'?'‚ö†Ô∏è Vencido':'üïò Em aberto');
        const link=i.billet_url?`<a class="btn" href="${i.billet_url}" target="_blank" rel="noopener">Boleto/PDF</a>`:'';
        return `<div class="item"><div><strong>${String(i.month).padStart(2,'0')}/${i.year}</strong> ‚Äî ${v}</div><div class="kv">${st}</div><div style="margin-top:6px">${link}</div></div>`;
      }).join('') : '<div class="item">Sem dados aqui ainda ‚Äî use o bot√£o para abrir no app atual.</div>';
    }catch{ $('invoicesList').innerHTML = '<div class="item">Integra√ß√£o direta n√£o configurada ‚Äî use o bot√£o acima.</div>'; }
  }
  function explainBillingIntegration(){
    alert('Integra√ß√µes: podemos puxar dados do app atual via endpoint/planilha (Edge Function) ou sincronizar na tabela "invoices" do Supabase. Eu te passo os arquivos quando decidir.');
  }

  /* ---------- Integra√ß√µes externas (deep links) ---------- */
  function openLogoApp(){
    const isAndroid=/Android/i.test(navigator.userAgent);
    if(isAndroid){ const i=document.createElement('iframe'); i.style.display='none'; i.src=DEEPLINK_LOGO; document.body.appendChild(i); setTimeout(()=>{ window.location.href=PLAY_LOGO; },1200); setTimeout(()=>{ document.body.removeChild(i); },2000); }
    else { window.open(PLAY_LOGO,'_blank'); }
  }
  function setupExternalButtons(){
    const bookings=$('openExternalBookings'); if(bookings){ bookings.href=DEEPLINK_LOGO; bookings.onclick=(e)=>{ e.preventDefault(); openLogoApp(); }; }
    const news=$('openExternalNews'); if(news){ news.href=URL_COMUNICADOS; news.onclick=(e)=>{ if(URL_COMUNICADOS.startsWith('http')) return; e.preventDefault(); openLogoApp(); }; }
    const bills=$('openExternalBills'); if(bills){ bills.href=URL_FINANCEIRO; bills.onclick=(e)=>{ if(URL_FINANCEIRO.startsWith('http')) return; e.preventDefault(); openLogoApp(); }; }
  }

  /* ---------- Helpers ---------- */
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmt = s => { try{ return new Date(s).toLocaleString('pt-BR'); }catch{ return s; } };

  // Sess√£o existente
  (async ()=>{ const { data } = await client.auth.getSession(); if(data.session){ await boot(); } else { updateAuthUI(false); } })();

  /* ---------- INSTALA√á√ÉO PWA ---------- */
  let deferredPrompt=null;
  const installBanner=$('installBanner'), installBtn=$('installBtn'), installHint=$('installHint');
  const isStandalone=()=> (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone===true);
  const isIOS=()=>/iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isAndroid=()=>/Android/i.test(navigator.userAgent);
  function showInstallBanner(mode){ if(isStandalone()) return; installBanner.style.display='block'; if(mode==='android'){ installBtn.style.display='inline-block'; installHint.textContent='Toque em ‚ÄúInstalar agora‚Äù.'; } else if(mode==='ios'){ installBtn.style.display='none'; installHint.innerHTML='No Safari: <b>Compartilhar</b> ‚Üí <b>Adicionar √† Tela de In√≠cio</b>.'; } else { installBtn.style.display='none'; installHint.textContent='Menu do navegador ‚Üí ‚ÄúAdicionar √† tela inicial‚Äù.'; } }
  window.hideInstallBanner=()=> installBanner.style.display='none';
  window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; showInstallBanner('android'); });
  window.addEventListener('load',()=>{ if(isIOS() && !isStandalone()) showInstallBanner('ios'); });
  setTimeout(()=>{ if(isAndroid() && !isStandalone() && !deferredPrompt) showInstallBanner('generic'); },3500);
  installBtn?.addEventListener('click', async ()=>{ try{ if(!deferredPrompt){ installHint.textContent='Se n√£o abrir: menu ‚ãÆ ‚Üí ‚ÄúAdicionar √† tela inicial‚Äù.'; return; } deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; hideInstallBanner(); }catch{} });

  /* ---------- EMOJI PICKER ---------- */
  const EMOJIS="üòÄ üòÉ üòÑ üòÅ üòÜ üòÖ üòÇ üôÇ üòâ üòä üòç üòò üòé ü§© ü§î üôè üëç üëè üôå ü§ù üí° üéâ ü•≥ üèÜ üîß üßπ üõ†Ô∏è üõéÔ∏è üöó üè† üßë‚Äçüîß üîå üîã üß∞ üì¶ üìû üìç".split(' ');
  const emojiGrid=$('emojiGrid'), emojiPanel=$('emojiPanel'), emojiToggle=$('emojiToggle'), chatInput=$('chatInput');
  EMOJIS.forEach(e=>{ const b=document.createElement('button'); b.type='button'; b.textContent=e; b.style.border='none'; b.style.background='transparent'; b.style.fontSize='22px'; b.style.cursor='pointer'; b.onclick=()=>{ insertAtCursor(chatInput,e+' '); emojiPanel.style.display='none'; chatInput.focus(); }; emojiGrid.appendChild(b); });
  emojiToggle?.addEventListener('click',()=>{ emojiPanel.style.display = (emojiPanel.style.display==='block'?'none':'block'); });
  document.addEventListener('click',(ev)=>{ if(emojiPanel && !emojiPanel.contains(ev.target) && ev.target!==emojiToggle) emojiPanel.style.display='none'; });
  function insertAtCursor(input,text){ const s=input.selectionStart||input.value.length; const e=input.selectionEnd||input.value.length; input.value=input.value.substring(0,s)+text+input.value.substring(e); input.selectionStart=input.selectionEnd=s+text.length; }

  /* ---------- PUSH NOTIFICATIONS (cliente) ---------- */
  const notifyBtn=$('notifyBtn');
  notifyBtn?.addEventListener('click', enablePush);

  async function enablePush(){
    if(!('serviceWorker' in navigator)){ alert('Seu navegador n√£o suporta notifica√ß√µes.'); return; }
    if(Notification.permission==='denied'){ alert('Notifica√ß√µes bloqueadas no navegador. Habilite nas configura√ß√µes.'); return; }
    if(!VAPID_PUBLIC_KEY){ alert('Para ativar notifica√ß√µes: gere uma VAPID PUBLIC KEY e cole em VAPID_PUBLIC_KEY no index.html. Tamb√©m crie a tabela push_subscriptions no Supabase.'); return; }

    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY) });
    // guardar no Supabase
    await client.from('push_subscriptions').upsert({
      endpoint: sub.endpoint,
      keys_p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey('p256dh')))),
      keys_auth: btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey('auth')))),
      user_id: (await client.auth.getUser())?.data?.user?.id || null,
      created_at: new Date().toISOString()
    }, { onConflict: 'endpoint' });
    alert('Notifica√ß√µes ativadas! Voc√™ receber√° alertas de novas mensagens do chat.');
  }

  function urlBase64ToUint8Array(base64String){
    const padding='='.repeat((4-base64String.length%4)%4);
    const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/');
    const raw=atob(base64); const arr=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++) arr[i]=raw.charCodeAt(i); return arr;
  }

  </script>

  <!-- Registrar service worker -->
  <script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js'); });
  }
  </script>
</body>
</html>
