<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CondUnity - Mansão Jorge Amado</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
:root{--bg:#f7f9fc;--card:#ffffff;--text:#0f172a;--muted:#475569;--primary:#2563eb}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--text)}
.header{padding:20px 16px;display:flex;align-items:center;gap:12px;background:#fff;box-shadow:0 1px 0 rgba(15,23,42,.06);position:sticky;top:0;z-index:10}
.logo{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.title{font-size:20px;font-weight:700}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.nav button{padding:10px 14px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer}
.nav button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 2px 6px rgba(15,23,42,.04)}
.row{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{padding:10px;border:1px solid #cbd5e1;border-radius:10px}
textarea{min-height:90px}
button.primary{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;color:#334155}
.hidden{display:none}
.list{display:grid;gap:8px}
.item{padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
.kv{font-size:12px;color:var(--muted)}
.sidebar{min-width:280px}
.flex{display:flex;gap:16px}
.flex-1{flex:1}
.chat-box{height:280px;overflow:auto;border:1px solid #e2e8f0;border-radius:10px;padding:10px;background:#f8fafc}
.msg{padding:6px 8px;border-radius:10px;background:#eef2ff;margin-bottom:6px;line-height:1.35}
.footer{padding:24px;text-align:center;color:#64748b}
.small{font-size:12px;color:#64748b}
</style>
</head>
<body>
  <header class="header">
    <!-- ÍCONE / LOGO CONDUNITY -->
    <div class="logo">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none"
           xmlns="http://www.w3.org/2000/svg" style="display:block;border-radius:10px">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
            <stop offset="0" stop-color="#1d4ed8"/><stop offset="1" stop-color="#22d3ee"/>
          </linearGradient>
        </defs>
        <rect width="40" height="40" rx="10" fill="url(#g)"/>
        <text x="20" y="24" text-anchor="middle"
              font-family="Inter, Segoe UI, Arial, sans-serif"
              font-size="11.5" font-weight="800" fill="#fff">CondU</text>
      </svg>
    </div>
    <div class="title">CondUnity • Mansão Jorge Amado</div>
    <div style="margin-left:auto" class="small" id="whoami"></div>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Senha">
        <button class="primary" onclick="login()">Entrar</button>
        <button onclick="signup()">Criar conta</button>
        <button onclick="logout()">Sair</button>
        <span class="badge" id="roleBadge" title="Perfil"></span>
      </div>
      <div class="small">Dica: use os logins de teste do Supabase (síndico e morador).</div>
    </div>

    <div class="nav">
      <button id="tabBtn-chat" class="active" onclick="openTab('chat')">Chat</button>
      <button id="tabBtn-posts" onclick="openTab('posts')">Comunicados</button>
      <button id="tabBtn-bookings" onclick="openTab('bookings')">Reservas</button>
      <button id="tabBtn-ads" onclick="openTab('ads')">Parceiros</button>
      <button id="tabBtn-profile" onclick="openTab('profile')">Perfil</button>
    </div>

    <div class="flex">
      <div class="flex-1">
        <!-- CHAT -->
        <section id="tab-chat" class="card">
          <h3>Chat Geral do Condomínio</h3>
          <div id="chatBox" class="chat-box"></div>
          <div class="row" style="margin-top:8px">
            <input id="chatInput" class="flex-1" placeholder="Escreva uma mensagem...">
            <button class="primary" onclick="sendMessage()">Enviar</button>
          </div>
        </section>

        <!-- POSTS -->
        <section id="tab-posts" class="card hidden">
          <h3>Comunicados</h3>
          <div id="postsList" class="list"></div>
          <div id="postForm" class="card hidden" style="margin-top:10px">
            <div class="row"><input id="postTitle" class="flex-1" placeholder="Título"></div>
            <div class="row"><textarea id="postContent" class="flex-1" placeholder="Conteúdo"></textarea></div>
            <button class="primary" onclick="createPost()">Publicar comunicado</button>
          </div>
        </section>

        <!-- BOOKINGS -->
        <section id="tab-bookings" class="card hidden">
          <h3>Reservas</h3>
          <div class="row">
            <select id="amenitySelect"></select>
            <input id="startAt" type="datetime-local">
            <input id="endAt" type="datetime-local">
            <button class="primary" onclick="requestBooking()">Solicitar</button>
          </div>
          <div class="small">Dica: Síndico pode aprovar/rejeitar abaixo.</div>
          <div id="bookingsList" class="list" style="margin-top:10px"></div>
        </section>

        <!-- PROFILE -->
        <section id="tab-profile" class="card hidden">
          <h3>Perfil</h3>
          <div id="profileInfo"></div>
        </section>
      </div>

      <!-- ADS -->
      <aside class="sidebar">
        <section id="tab-ads" class="card">
          <h3>Parceiros</h3>
          <div id="adsBox" class="list"></div>
        </section>
      </aside>
    </div>
  </div>

  <footer class="footer">CondUnity • MVP gratuito • Supabase + GitHub Pages</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // === TROQUE AQUI (ou mantenha suas chaves atuais) ===
  const SUPABASE_URL = 'https://kqkahzfzxbzqwjtkyqhe.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtxa2FoemZ6eGJ6cXdqdGt5cWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODk0MTcsImV4cCI6MjA3Mzk2NTQxN30.AyvxACf6RutV35-3gFpUlfutjG9NZzY6ZtCgDijuCrM';
  // ====================================================
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let session=null, profile=null, condoId=null, generalRoomId=null, isManager=false;

  const $ = id => document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');
  function openTab(k){ ['chat','posts','bookings','ads','profile'].forEach(t=>{ const s=$('tab-'+t), b=$('tabBtn-'+t); if(t===k){show(s); b.classList.add('active')} else {hide(s); b.classList.remove('active')} }); }

  async function login(){
    const { data, error } = await client.auth.signInWithPassword({ email:$('email').value, password:$('password').value });
    if(error){ alert(error.message); return; }
    session = data.session;
    $('whoami').innerText = data.user.email;
    await boot();
  }
  async function signup(){
    const { error } = await client.auth.signUp({ email:$('email').value, password:$('password').value });
    if(error){ alert(error.message); return; }
    alert('Conta criada! (no piloto, deixe "Confirm email" desativado no Supabase)');
  }
  async function logout(){ await client.auth.signOut(); location.reload(); }

  async function boot(){
    // 1) Usuário logado
    const { data: userData } = await client.auth.getUser();
    const uid = userData?.user?.id;
    if(!uid){ alert('Sem sessão'); return; }

    // 2) Perfil pelo uid (exige policy "profiles: read own")
    const { data: me, error: eProf } = await client.from('profiles')
      .select('id, full_name, role, condominium_id, unit_id')
      .eq('id', uid).single();
    if(eProf){ alert('Erro ao ler perfil: '+eProf.message); return; }
    profile = me; condoId = me.condominium_id; isManager = (me.role === 'manager' || me.role === 'admin');
    $('roleBadge').innerText = isManager ? 'Manager' : 'Resident';

    // 3) Sala "Geral"
    const { data: room, error: eRoom } = await client.from('chat_rooms').select('id').eq('name','Geral').single();
    if(eRoom){ alert('Sala de chat não encontrada'); return; }
    generalRoomId = room.id;

    // 4) Módulos
    listenChat(); await loadChat();
    if(isManager) show($('postForm')); else hide($('postForm'));
    await loadPosts(); await loadAmenities(); await loadBookings(); await loadAds();

    // 5) Perfil visual
    $('profileInfo').innerHTML = `
      <div class="item">
        <div><strong>Nome:</strong> ${me?.full_name || '-'}</div>
        <div><strong>Role:</strong> ${me?.role}</div>
        <div><strong>Unidade:</strong> ${me?.unit_id || '-'}</div>
      </div>`;
  }

  // ===== CHAT =====
  async function loadChat(){
    const { data, error } = await client
      .from('chat_messages')
      .select('content, created_at, room_id, sender_name')
      .eq('room_id', generalRoomId)
      .order('created_at',{ascending:true})
      .limit(200);
    if(error){ alert('Erro ao carregar chat: '+error.message); return; }

    $('chatBox').innerHTML = (data||[]).map(m=>{
      const who = m.sender_name ? `<strong>${escapeHtml(m.sender_name)}</strong> • ` : '';
      return `<div class="msg">
        <span class="kv">${who}${new Date(m.created_at).toLocaleString('pt-BR')}</span><br>
        ${escapeHtml(m.content)}
      </div>`;
    }).join('');
    $('chatBox').scrollTop = $('chatBox').scrollHeight;
  }

  async function sendMessage(){
    const text = $('chatInput').value.trim(); if(!text) return;
    const displayName =
      (profile?.full_name && profile.full_name.trim()) ||
      ($('whoami').innerText || 'Usuário');

    const { error } = await client.from('chat_messages').insert({
      room_id: generalRoomId,
      content: text,
      sender_id: profile?.id || null,
      sender_name: displayName
    });
    if (error) { alert('Erro ao enviar: ' + error.message); return; }
    $('chatInput').value='';
  }

  function listenChat(){
    client.channel('chat-insert')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'chat_messages'}, payload=>{
        if(payload.new.room_id !== generalRoomId) return;
        const m = payload.new;
        const who = m.sender_name ? `<strong>${escapeHtml(m.sender_name)}</strong> • ` : '';
        const div = document.createElement('div');
        div.className='msg';
        div.innerHTML = `<span class="kv">${who}${new Date(m.created_at).toLocaleString('pt-BR')}</span><br>${escapeHtml(m.content)}`;
        $('chatBox').appendChild(div);
        $('chatBox').scrollTop = $('chatBox').scrollHeight;
      })
      .subscribe();
  }

  // ===== POSTS =====
  async function loadPosts(){
    const { data, error } = await client.from('posts')
      .select('id,title,content,created_at')
      .eq('condominium_id', condoId)
      .order('created_at',{ascending:false})
      .limit(50);
    if(error){ $('postsList').innerHTML='<div class="item">Sem permissão para ler comunicados.</div>'; return; }
    $('postsList').innerHTML = (data||[]).map(p=>`<div class="item"><div><strong>${escapeHtml(p.title)}</strong></div><div class="kv">${new Date(p.created_at).toLocaleString('pt-BR')}</div><div>${escapeHtml(p.content)}</div></div>`).join('');
  }
  async function createPost(){
    const title = $('postTitle').value.trim(), content = $('postContent').value.trim();
    if(!title || !content){ alert('Preencha título e conteúdo'); return; }
    const { error } = await client.from('posts').insert({ condominium_id: condoId, author_id: profile.id, title, content });
    if(error){ alert('Erro ao publicar: '+error.message); return; }
    $('postTitle').value=''; $('postContent').value=''; await loadPosts();
  }

  // ===== RESERVAS =====
  async function loadAmenities(){
    const { data } = await client.from('amenities').select('id,name').eq('condominium_id', condoId).order('name');
    $('amenitySelect').innerHTML = (data||[]).map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
  }
  async function requestBooking(){
    const amenity_id = $('amenitySelect').value;
    const starts_at = $('startAt').value? new Date($('startAt').value).toISOString(): null;
    const ends_at = $('endAt').value? new Date($('endAt').value).toISOString(): null;
    if(!amenity_id || !starts_at || !ends_at){ alert('Preencha área e horários'); return; }
    const { error } = await client.from('bookings').insert({ condominium_id: condoId, amenity_id, requester_id: profile.id, starts_at, ends_at });
    if(error){ alert('Erro ao solicitar: '+error.message); return; }
    await loadBookings();
  }
  async function loadBookings(){
    const { data } = await client.from('bookings')
      .select('id,amenity_id,starts_at,ends_at,status')
      .eq('condominium_id', condoId)
      .order('starts_at',{ascending:false})
      .limit(50);
    $('bookingsList').innerHTML = (data||[]).map(b=>{
      const actions = (isManager && b.status==='pending')
        ? `<button onclick="setBooking('${b.id}','approved')">Aprovar</button> <button onclick="setBooking('${b.id}','rejected')">Rejeitar</button>`
        : `<span class="badge">${b.status}</span>`;
      return `<div class="item"><div><strong>${b.amenity_id}</strong></div><div class="kv">${fmt(b.starts_at)} → ${fmt(b.ends_at)}</div><div>${actions}</div></div>`;
    }).join('');
  }
  async function setBooking(id,status){
    const { error } = await client.from('bookings').update({ status }).eq('id', id);
    if(error){ alert('Erro ao atualizar: '+error.message); return; }
    await loadBookings();
  }

  // ===== ADS =====
  async function loadAds(){
    const now = new Date().toISOString();
    const { data } = await client.from('partner_ads')
      .select('title,image_url,link_url,priority,starts_at,ends_at,is_active')
      .eq('condominium_id', condoId).order('priority',{ascending:false});
    const filtered = (data||[]).filter(a=> a.is_active && (!a.starts_at || a.starts_at<=now) && (!a.ends_at || a.ends_at>=now));
    $('adsBox').innerHTML = filtered.map(a=>`
      <a class="item" href="${a.link_url||'#'}" target="_blank">
        <div><strong>${escapeHtml(a.title)}</strong></div>
        ${a.image_url ? `<img src="${a.image_url}" alt="${escapeHtml(a.title)}" style="width:100%;border-radius:8px;margin-top:6px">` : ''}
      </a>`).join('');
  }

  // Helpers
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmt = s => { try{ return new Date(s).toLocaleString('pt-BR'); }catch{ return s; } };

  // Restaura sessão se já estava logado
  (async ()=>{ const { data } = await client.auth.getSession(); if(data.session){ $('whoami').innerText = data.session.user.email; await boot(); } })();

  // Service Worker (PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
  </script>
</body>
</html>
